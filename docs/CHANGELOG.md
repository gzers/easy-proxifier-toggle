# 配置系统重构总结

## 更新日期
2026-01-18

## 更新内容

### 1. 新增文件

#### `config_manager.py`
配置管理模块，负责：
- 加载和保存配置文件（`config.json`）
- 提供配置访问接口
- 处理配置文件不存在或损坏的情况
- 提供默认配置值

#### `settings_gui.py`
GUI 设置窗口，提供：
- 可视化配置界面
- Proxifier 路径浏览选择
- 服务名称编辑
- 配置保存功能
- 输入验证

#### `config.json`
配置文件，存储：
- `proxifier_exe_path`: Proxifier 可执行文件路径
- `service_name`: Proxifier 驱动服务名称

#### `config.example.json`
配置文件示例，供用户参考

### 2. 修改文件

#### `proxifier_toggler.py`
- 移除硬编码的配置常量（`PROXIFIER_EXE_PATH` 和 `SERVICE_NAME`）
- 导入 `config_manager` 和 `settings_gui` 模块
- 更新所有配置引用，改为动态从配置文件读取
- 添加"设置"菜单项到系统托盘菜单
- 新增 `open_settings_window()` 函数，在独立线程中打开设置窗口

#### `.gitignore`
- 添加 `config.json` 到忽略列表，避免提交用户特定配置

#### `README.md`
- 更新功能特性列表，添加 GUI 配置和配置持久化
- 更新配置说明，介绍 GUI 和手动配置两种方式
- 更新托盘菜单功能说明，添加"设置"选项

#### `CONFIG.md`
- 完全重写配置说明文档
- 详细说明 GUI 配置和手动配置方法
- 添加常见问题解答

## 技术实现

### 配置加载流程
1. 程序启动时，`config_manager.load_config()` 检查配置文件是否存在
2. 如果不存在，创建默认配置文件
3. 如果存在但缺少某些键，自动补充默认值
4. 每次执行操作时，动态读取最新配置

### GUI 设置窗口
- 使用 tkinter 构建界面
- 在独立线程中运行，避免阻塞托盘图标
- 提供文件浏览对话框选择 Proxifier 路径
- 保存前进行输入验证
- 保存成功后显示提示信息

### 配置持久化
- 使用 JSON 格式存储配置
- UTF-8 编码，支持中文路径
- 配置文件位于程序所在目录
- 支持手动编辑和程序修改

## 优势

1. **用户友好**：无需编辑 Python 代码，通过 GUI 即可配置
2. **配置持久化**：配置保存在独立文件中，升级程序不会丢失配置
3. **灵活性**：支持 GUI 和手动编辑两种配置方式
4. **可维护性**：配置逻辑集中在 `config_manager` 模块中
5. **扩展性**：易于添加新的配置项
6. **安全性**：配置文件不会被提交到版本控制

## 向后兼容性

- 首次运行时自动创建配置文件，使用原有的默认值
- 用户无需手动迁移配置
- 如果配置文件损坏或缺失，自动使用默认值

## 使用建议

1. **首次使用**：运行程序后，通过"设置"菜单配置 Proxifier 路径
2. **修改配置**：推荐使用 GUI 设置窗口，避免手动编辑时出错
3. **备份配置**：可以备份 `config.json` 文件，方便迁移到其他电脑
4. **重置配置**：删除 `config.json` 文件，程序会自动创建默认配置

## 文件结构

```
easy-proxifier-toggle/
├── proxifier_toggler.py      # 主程序（已更新）
├── config_manager.py          # 配置管理模块（新增）
├── settings_gui.py            # 设置窗口（新增）
├── config.json                # 配置文件（自动生成）
├── config.example.json        # 配置示例（新增）
├── CONFIG.md                  # 配置说明（更新）
├── README.md                  # 项目说明（更新）
├── .gitignore                 # Git 忽略文件（更新）
└── requirements.txt           # 依赖列表
```

## 测试建议

1. 测试首次运行，验证配置文件自动创建
2. 测试 GUI 设置窗口，验证配置保存和加载
3. 测试手动编辑配置文件，验证程序正确读取
4. 测试配置文件损坏情况，验证默认值回退
5. 测试配置修改后的 Proxifier 切换功能
