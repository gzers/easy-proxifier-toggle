# 自动权限提升功能恢复 - 更新说明

## 更新日期
2026-01-18

## 更新内容

### 恢复了自动管理员权限提升功能

根据用户反馈，恢复了程序启动时自动弹出 UAC 对话框请求管理员权限的功能。

### 主要变更

1. **恢复了 `src/utils/admin.py` 模块**
   - `is_admin()` - 检查是否有管理员权限
   - `run_as_admin()` - 自动请求管理员权限并重启程序

2. **更新了 `src/main.py`**
   - 程序启动时自动调用 `run_as_admin()`
   - 如果没有管理员权限，会弹出 UAC 对话框
   - 支持通过环境变量 `SKIP_ADMIN_CHECK=1` 跳过权限检查

3. **更新了 `run.py`**
   - 正常模式：自动请求管理员权限
   - 开发模式 (`--dev`)：跳过权限检查，不弹出 UAC 对话框

### 使用方式

#### 正常使用（推荐）

```bash
python run.py
```

**运行流程**：
1. 程序启动
2. 检查是否有管理员权限
3. 如果没有，弹出 UAC 对话框
4. 用户点击"是"授予权限
5. 程序以管理员权限重新启动
6. 托盘图标出现

#### 开发调试模式

```bash
python run.py --dev
```

**特点**：
- 跳过管理员权限检查
- 不弹出 UAC 对话框
- 显示详细调试信息
- 命令行窗口保持打开
- ⚠️ 服务控制功能可能无法工作

### 技术实现

使用 Windows API `ShellExecuteW` 的 `"runas"` 动作来触发 UAC 对话框：

```python
ctypes.windll.shell32.ShellExecuteW(
    None, "runas", sys.executable, f'"{script}" {params}', None, 1
)
```

这会：
1. 触发 Windows UAC 对话框
2. 以管理员权限重新启动程序
3. 退出当前进程

### 优势

1. **用户友好** - 无需手动以管理员身份运行
2. **自动化** - 程序自动处理权限问题
3. **灵活** - 开发模式可以跳过权限检查
4. **标准** - 使用 Windows 标准的 UAC 机制

### 向后兼容性

- ✅ 配置文件格式不变
- ✅ 功能完全兼容
- ✅ 启动方式更简单（直接运行即可）
- ✅ 保留了开发模式的灵活性

## 总结

现在用户只需运行 `python run.py`，程序会自动弹出 UAC 对话框请求管理员权限，无需手动操作。这提供了更好的用户体验，同时保留了开发模式的灵活性。
